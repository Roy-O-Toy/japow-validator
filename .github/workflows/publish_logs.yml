name: Publish Validation Logs to GitHub Pages

on:
  workflow_run:
    workflows: ["Daily Resort Validation"]  # Must match the name of your validation workflow
    types:
      - completed
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read  # Required to access artifacts from another workflow

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages

      - name: Wait for artifact to be ready
        run: |
          echo "‚è≥ Waiting 30 seconds for GitHub to register the artifact..."
          sleep 30

      - name: Manually download artifact via API
        run: |
          echo "Fetching artifact ID from triggering workflow..."
          ARTIFACT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
            --jq '.artifacts[] | select(.name=="validation-logs") | .id')

          if [ -z "$ARTIFACT_ID" ]; then
            echo "‚ùå Artifact 'validation-logs' not found in triggering workflow."
            exit 1
          fi

          echo "Artifact ID found: $ARTIFACT_ID"
          echo "Downloading artifact..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip > validation-logs.zip

          echo "Extracting artifact..."
          unzip -o validation-logs.zip -d logs/

      - name: Prepare latest.json
        run: |
          echo "üì¶ Copying most recent validation log to latest.json..."
          LATEST_FILE=$(ls -t logs/*.json | head -n 1)
          if [ -z "$LATEST_FILE" ]; then
            echo "‚ùå No JSON files found in logs/."
            exit 1
          fi
          cp "$LATEST_FILE" logs/latest.json

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push to gh-pages
        run: |
          git add logs/
          git commit -m "Add latest validation logs [skip ci]" || echo "No changes to commit"
          git push origin gh-pages

