name: Publish Validation Logs to GitHub Pages

on:
  workflow_run:
    workflows: ["Daily Resort Validation"]   # must match exactly the name in validation.yml
    types:
      - completed
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read           # required to access artifacts from another workflow

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    env:
      GH_TOKEN: ${{ github.token }}           # authenticates gh CLI

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages

      - name: Wait for artifact to be ready
        run: |
          echo "‚è≥ Waiting 30 seconds for GitHub to register the artifact..."
          sleep 30

      - name: Download validation-logs artifact
        run: |
          echo "Fetching artifact ID from triggering workflow..."
          ARTIFACT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
            --jq '.artifacts[] | select(.name=="validation-logs") | .id')

          if [ -z "$ARTIFACT_ID" ]; then
            echo "‚ùå Artifact 'validation-logs' not found in triggering workflow."
            gh api \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
              --jq '.artifacts[].name'
            exit 1
          fi

          echo "Artifact ID found: $ARTIFACT_ID"
          echo "Downloading artifact..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip > validation-logs.zip

          echo "Extracting artifact..."
          unzip -o validation-logs.zip -d logs/

      - name: Copy newest validator JSON to latest.json
        run: |
          echo "üìÇ Contents of logs/:"
          ls -lah logs

          LATEST_FILE=$(ls -t logs/validation_*.json 2>/dev/null | head -n 1)

          if [ -z "$LATEST_FILE" ]; then
            echo "‚ùå No validator output (validation_*.json) found ‚Äî aborting publish."
            exit 1
          fi

          cp "$LATEST_FILE" logs/latest.json
          echo "üì¶ Copied $LATEST_FILE ‚Üí logs/latest.json"

      - name: Configure Git and commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add logs/
          git commit -m "Add latest validation logs [skip ci]" || echo "No changes to commit"
          git push origin gh-pages
